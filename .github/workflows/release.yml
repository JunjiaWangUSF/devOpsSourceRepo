name: Release
on:
  push:
    branches: [main]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Allows pushing to the repository
      issues: write # Allows creating issues
      pull-requests: write # If using pull requests
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - run: npm ci

      - name: Run Semantic Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release

      - name: Set RC_VERSION
        run: |
          # Check if the file exists
          if [[ ! -f .rc_version ]]; then
            echo "❌ Error: .rc_version file not found"
            exit 1
          fi

          # Extract the LAST occurrence of RC_VERSION
          RC_VERSION=$(grep 'RC_VERSION=' .rc_version | tail -1 | cut -d= -f2 | tr -d '[:space:]')

          # Validate format
          if [[ ! "$RC_VERSION" =~ ^rc[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid RC_VERSION format: $RC_VERSION"
            exit 1
          fi

          # Optional: Warn about duplicates but proceed
          RC_LINES=$(grep -c 'RC_VERSION=' .rc_version)
          if [[ "$RC_LINES" -gt 1 ]]; then
            echo "⚠️ Warning: Multiple RC_VERSION entries found. Using the LAST one: $RC_VERSION"
          fi

          # Set environment variable
          echo "RC_VERSION=$RC_VERSION" >> $GITHUB_ENV

      - name: Trigger repository dispatch
        uses: actions/github-script@v7
        env:
          RC_VERSION: ${{ env.RC_VERSION }}
          INFRA_TOKEN: ${{ secrets.REPO_DISPATCH_TOKEN }}
        with:
          script: |
            try {
              await github.rest.repos.createDispatchEvent({
                owner: 'JunjiaWangUSF',
                repo: 'devOpsInfraRepo',
                event_type: 'promote-rc',
                client_payload: {
                  rc_version: process.env.RC_VERSION,
                  image_tag: 'latest'
                },
                headers: { authorization: `token ${process.env.INFRA_TOKEN}` }
              });
              console.log('Dispatch event triggered successfully');
            } catch (error) {
              console.error('Error triggering dispatch:', error);
              throw error;  // Fail the step
            }
